<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor — DBTeam Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="shared.css" />
  <link rel="icon" href="/logo.svg">
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="brand" href="index.html"><img src="logo.svg" class="logo" alt="DBTeam"/> <span>DBTeam</span></a>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="index.html">Inicio</a>
        <a href="chat.html">Chat</a>
        <a href="telegram.html">Telegram</a>
        <a href="monitor.html">Monitor</a>
        <a href="traducciones.html">Traducciones</a>
        <a href="links.html">Enlaces</a>
        <a href="status.html">Estado</a>
        <a href="wsl_install.html">WSL install</a>
      </nav>
      <div class="header-actions">
        <a href="login.html" class="btn">Login</a>
        <a href="register.html" class="btn ghost">Registro</a>
      </div>
      <button class="nav-toggle" aria-label="Abrir menú">☰</button>
    </div>
  </header>

  <main class="container">
    <h1>Monitor en vivo</h1>
    <p style="color:var(--muted)">Muestra los mensajes/actividades recientes en los bots. Conecta a la API base indicada.</p>

    <label for="apiBaseMon">API base (ej. http://localhost:8081):</label>
    <input id="apiBaseMon" type="text" value="http://localhost:8081" />

    <label for="apiKeyMon">API Key (opcional):</label>
    <input id="apiKeyMon" type="text" value="yZc4OLfdUny6q/I/AGs7RqAJ4orRLAckndG1fEFnuXw=" placeholder="Token de sesión o API key" />
    <div class="controls">
      <button id="start">Iniciar monitor</button>
      <button id="stop" class="secondary">Detener</button>
    </div>

    <section id="apiDocs">
      <h2>APIs disponibles</h2>
      <p>El backend expone los siguientes endpoints útiles para monitorizar y depurar el bot:</p>
      <ul>
        <li><strong>GET /stats</strong> — Devuelve un JSON con estadísticas básicas (chats, usuarios, conteos, infohash_count). Requiere <code>Authorization: Bearer &lt;API_KEY&gt;</code>.</li>
        <li><strong>GET /messages</strong> — Devuelve las últimas líneas del <code>bot.log</code> como un array JSON. Requiere autorización Bearer.</li>
      </ul>
      <p>Puerto por defecto: <code>8081</code> (configurable en la caja <em>API base</em> arriba).</p>

      <h3>Ejemplos</h3>
      <pre style="background:#0b0b0b;padding:8px;border-radius:6px;color:#dcdcdc;overflow:auto"># curl
curl -H "Authorization: Bearer &lt;TU_SECRET&gt;" http://127.0.0.1:8081/stats

    <div class="controls">
$secret = (Get-Content .env | Where-Object { $_ -match '^WEB_API_SECRET=' }) -replace '^[^=]*=' , '' ; $secret = $secret.Trim('"') ; Invoke-RestMethod -Uri 'http://127.0.0.1:8081/stats' -Headers @{ Authorization = "Bearer $secret" }</pre>

      <div style="margin-top:8px">
        <label for="saveApiKey">Guardar API key localmente (localStorage):</label>
        <button id="saveApiKey" class="secondary" style="margin-left:8px">Guardar</button>
        <button id="clearApiKey" class="secondary" style="margin-left:8px">Borrar</button>
        <small style="display:block;margin-top:6px;color:var(--muted)">Guardar la API key en localStorage facilita recargas del monitor; no se envía al servidor hasta que pulses Iniciar.</small>
      </div>
    </section>

    <section id="botControl">
      <h2>Control del Bot</h2>
      <p>Acciones remotas: reiniciar/iniciar el proceso del bot en el host.</p>
      <label for="ctrlToken">Token (opcional, si no se usa el env):</label>
      <input id="ctrlToken" type="text" placeholder="Bot token para iniciar" />
      <label for="ctrlMin">Min interval (s):</label>
      <input id="ctrlMin" type="text" value="1.0" style="width:80px" />
      <label for="ctrlMax">Max concurrent:</label>
      <input id="ctrlMax" type="text" value="1" style="width:60px" />
      <div style="margin-top:8px">
        <button id="btnRestart" class="secondary">Reiniciar bot</button>
        <span id="ctrlResult" style="margin-left:12px;color:var(--muted)"></span>
      </div>
    </section>
      <button id="start">Iniciar monitor</button>
      <button id="stop" class="secondary">Detener</button>
    </div>

    <section id="pagesSection">
      <h2>Páginas disponibles</h2>
      <div id="pagesList" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>
    </section>

    <section id="live">
      <h2>Actividad reciente</h2>
      <div id="stream" style="max-height:60vh;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px solid rgba(255,255,255,0.02)"></div>
    </section>

    <footer>
      <small class="hint">El monitor hace polling cada 2s al endpoint <code>/messages</code>. Requiere que el backend esté accesible y que la API Key tenga permisos.</small>
    </footer>
  </main>
  <script src="app.js"></script>
  <script src="monitor.js"></script>
  <script src="shared.js"></script>

  <!-- Bubble side panel (shared) -->
  <aside class="bubble-panel" id="bubblePanel" aria-hidden="true">
    <button class="bubble-toggle" id="bubbleToggle" aria-label="Abrir panel">
      <img src="logo.svg" alt="logo" class="bubble-logo"/>
    </button>
    <div class="bubble-body" id="bubbleBody">
      <div class="bubble-header">
        <div class="bubble-title">DBTeam</div>
        <button id="bubbleClose" class="bubble-close" aria-label="Cerrar">✕</button>
      </div>
      <nav class="bubble-nav">
        <a href="chat.html">Chat</a>
        <a href="monitor.html">Monitor</a>
        <a href="#" id="linkSettings">Ajustes</a>
        <a href="#" id="linkAI">IA (endpoint)</a>
        <a href="#" id="linkDevices">Dispositivos</a>
        <a href="#" id="linkBackup">Backup/Restore</a>
      </nav>
      <div id="bubbleResources" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.02)"></div>
      <div class="bubble-footer">
        <button id="logoutBtn" class="secondary">Salir</button>
      </div>
    </div>
  </aside>
</body>
</html>
