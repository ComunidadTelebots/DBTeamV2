<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bot Control - Local</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 18px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; max-width: 820px; margin-bottom: 12px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    input[type=text], input[type=password] { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; }
    button { padding:8px 12px; border-radius:6px; border: none; background: var(--owner-color, #1e90ff); color: white; cursor:pointer; }
    button.secondary { background: #555; }
    pre { background:#f6f6f6; padding:8px; border-radius:6px; max-height:240px; overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    td, th { padding:6px; border-bottom:1px solid #eee; text-align:left }
  </style>
</head>
<body>
  <h2>Bot Control (localhost)</h2>

  <div class="card">
    <div><strong>Backend de control</strong> <small>(URL y API key que recibirá el servidor)</small></div>
    <div class="row">
      <input id="backend_url" type="text" placeholder="https://mi-backend" />
      <input id="backend_key" type="password" placeholder="API key (Bearer)" />
      <button id="btn_save_backend">Guardar</button>
    </div>
    <div style="font-size:0.9rem;color:#555">Se usará para todas las llamadas /bot/* y /processes/* desde esta web local.</div>
  </div>

  <div class="card">
    <div><strong>Registrar / Verificar token de Bot</strong></div>
    <div class="row">
      <input id="token" type="password" placeholder="Bot token (ej: 123456:ABC-... )" />
      <input id="dev_id" type="text" placeholder="Device id (opcional)" />
      <input id="dev_name" type="text" placeholder="Name (opcional)" />
      <button id="btn_verify">Verify & Register</button>
    </div>
    <div class="row">
      <button id="btn_add" class="secondary">Add device (no verify)</button>
      <button id="btn_refresh" class="secondary">Refresh accounts</button>
    </div>
    <div id="verify_res"></div>
  </div>

  <div class="card">
    <div><strong>Cuentas registradas</strong> <small>(desde Redis `web:devices`)</small></div>
    <div id="accounts_container">Cargando...</div>
  </div>

  <div class="card">
    <div><strong>Control de proceso</strong></div>
    <div class="row">
      <button id="btn_start">Start python_bot</button>
      <button id="btn_stop" class="secondary">Stop python_bot</button>
      <button id="btn_processes" class="secondary">Refresh processes</button>
    </div>
    <div id="process_res"></div>
  </div>

  <div class="card">
    <div><strong>Acciones rápidas para el grupo/bot</strong></div>
    <div class="row">
      <input id="quick_user_id" type="text" placeholder="ID usuario" />
      <button id="quick_ban">Banear</button>
      <button id="quick_mute">Mutear</button>
      <button id="quick_promote">Promover a admin</button>
      <button id="quick_perms">Editar permisos</button>
      <button id="quick_reply">Responder intervención</button>
    </div>
    <div id="quick_res"></div>
  </div>

  <div id="command_warning" style="display:none;color:red;font-weight:bold;margin:10px 0;"></div>

  <div id="block_command_panel" style="margin:15px 0;">
    <h3>Bloquear comando por usuario</h3>
    <input id="block_user_id" placeholder="ID de usuario" style="width:120px;">
    <input id="block_command_name" placeholder="Comando a bloquear" style="width:120px;">
    <button id="block_command_btn">Bloquear comando</button>
    <span id="block_command_res" style="margin-left:10px;color:darkred;"></span>
  </div>

  <div id="blocked_commands_panel" style="margin:15px 0;">
    <h3>Comandos bloqueados por usuario</h3>
    <table id="blocked_commands_table" border="1" style="width:100%;background:#fff;">
      <thead><tr><th>Usuario</th><th>Comando</th><th>Desbloquea en</th><th>Acción</th></tr></thead>
      <tbody></tbody>
    </table>
    <span id="unblock_command_res" style="color:green;"></span>
  </div>

  <div id="telegram_stats_panel" style="margin:15px 0;">
    <h3>Estadísticas de mensajes a Telegram</h3>
    <div id="telegram_stats_content">Cargando...</div>
    <canvas id="telegram_stats_graph" width="300" height="60" style="border:1px solid #ccc;margin-top:10px;"></canvas>
  </div>

  <div id="bots_limits_panel" style="margin:15px 0;">
    <h3>Límites y uso de mensajes por bot</h3>
    <table id="bots_limits_table" border="1" style="width:100%;background:#fff;">
      <thead><tr><th>Bot</th><th>Mensajes último segundo</th><th>Límite (msg/seg)</th><th>Porcentaje usado</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="/bot_control.js"></script>
  <script src="owner.js"></script>
</body>
</html>
