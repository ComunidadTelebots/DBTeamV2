  <section class="card" style="margin-bottom:18px">
    <h2 style="margin:0 0 10px 0">Panel unificado de chats y ban</h2>
    <button id="reloadUnifiedChatsBtn" class="ghost">Recargar</button>
    <div id="unifiedChatsPanel" style="background:#181f2a;padding:12px 8px;border-radius:10px;min-height:80px;max-height:420px;overflow-y:auto"></div>
  </section>
  <section class="card" style="margin-bottom:18px">
    <h2 style="margin:0 0 10px 0">Chats de Bots cl√°sicos</h2>
    <button id="reloadClassicChatsBtn" class="ghost">Recargar</button>
    <div id="classicChatsPanel" style="background:#181f2a;padding:12px 8px;border-radius:10px;min-height:80px;max-height:320px;overflow-y:auto"></div>
  </section>
  <section class="card" style="margin-bottom:18px">
    <h2 style="margin:0 0 10px 0">Chats de TDLib</h2>
    <button id="reloadTdlibChatsBtn" class="ghost">Recargar</button>
    <div id="tdlibChatsPanel" style="background:#181f2a;padding:12px 8px;border-radius:10px;min-height:80px;max-height:320px;overflow-y:auto"></div>
  </section>
  <section class="card" style="margin-bottom:18px">
    <h2 style="margin:0 0 10px 0">Estado de las traducciones</h2>
    <div id="translationStatusPanel" style="display:flex;flex-wrap:wrap;gap:18px"></div>
  </section>
  <script>
  async function fetchTranslationStatus() {
    const panel = document.getElementById('translationStatusPanel');
    panel.innerHTML = '<span style="color:var(--muted)">Cargando estado...</span>';
    try {
      // Puedes ajustar la ruta seg√∫n tu backend
      const res = await fetch('/i18n/status.json');
      if (!res.ok) throw new Error('No disponible');
      const data = await res.json();
      panel.innerHTML = '';
      for (const lang of data.languages) {
        const percent = Math.round((lang.translated / lang.total) * 100);
        const color = percent === 100 ? '#22c55e' : percent > 60 ? '#facc15' : '#ef4444';
        panel.innerHTML += `
          <div style="min-width:180px;background:var(--panel,#181f2a);border-radius:12px;padding:16px 18px;box-shadow:0 2px 8px #0001;display:flex;flex-direction:column;align-items:center;">
            <span style="font-weight:600;font-size:1.1rem;text-transform:capitalize">${lang.code}</span>
            <div style="width:100%;height:10px;background:#222;border-radius:6px;margin:10px 0 6px 0;overflow:hidden">
              <div style="width:${percent}%;height:100%;background:${color};transition:width 0.5s"></div>
            </div>
            <span style="font-size:0.98rem;color:${color}">${percent}%</span>
            <span style="font-size:0.92rem;color:#888">${lang.translated} / ${lang.total} traducidas</span>
          </div>
        `;
      }
    } catch (e) {
      panel.innerHTML = '<span style="color:#ef4444">No se pudo cargar el estado de las traducciones.</span>';
    }
  }
  fetchTranslationStatus();
  </script>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Owner - DBTeam</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/static/shared.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    :root {
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --bg: #071028;
      --card: #0b1220;
      --text: #e6eef8;
      --muted: #b0b8c9;
    }
    [data-theme="light"] {
      --bg: #f4f7fb;
      --card: #fff;
      --text: #1a2233;
      --muted: #6b7280;
    }
    body {
      background: linear-gradient(180deg, var(--bg), #021021);
      color: var(--text);
      font-family: Inter, Arial, sans-serif;
    }
    .site-header {
      background: var(--card);
      box-shadow: 0 2px 8px rgba(31,38,135,0.08);
    }
    .main-nav a, .header-actions a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
      margin-right: 12px;
      transition: color 0.2s;
    }
    .main-nav a:hover, .header-actions a:hover {
      color: var(--accent-2);
    }
    [data-theme="light"] .main-nav a, [data-theme="light"] .header-actions a {
      color: #2563eb;
    }
    [data-theme="light"] .main-nav a:hover, [data-theme="light"] .header-actions a:hover {
      color: #7c3aed;
    }
    .theme-toggle-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      margin-left: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .theme-toggle-btn:hover {
      background: var(--accent-2);
    }
    .geo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}
    .geo-block{padding:8px;border:1px solid var(--border, #e5e7eb);border-radius:10px;background:var(--panel, #0b1320)}
    .geo-map{margin-top:8px;height:260px;border:1px solid var(--border, #e5e7eb);border-radius:10px;overflow:hidden}
  </style>
</head>
<body>
  <header class="site-header">
  <aside id="notificationSidebar" style="position:fixed;right:-340px;top:0;height:100vh;width:320px;background:var(--card,#181f2a);box-shadow:-2px 0 8px #0002;z-index:1000;transition:right 0.3s;overflow-y:auto;padding:18px 16px 16px 16px;display:flex;flex-direction:column;gap:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-weight:700;font-size:1.2rem">Notificaciones</span>
      <button id="closeSidebarBtn" class="btn ghost" style="font-size:1.2rem">√ó</button>
    </div>
    <div style="margin-bottom:12px">
      <label for="tgChannelInput" style="font-size:0.95rem;color:#888">Canal Telegram para notificaciones</label>
      <input id="tgChannelInput" type="text" placeholder="@micanal o -100123456789" style="width:100%;margin-top:4px" />
      <button id="saveTgChannelBtn" class="btn" style="margin-top:6px">Guardar canal</button>
      <span id="tgChannelStatus" style="margin-left:8px;color:#888"></span>
    </div>
    <div id="notificationList"></div>
  </aside>
  <button id="openSidebarBtn" style="position:fixed;right:12px;top:60px;z-index:1001;background:var(--owner-color,#1e90ff);color:#fff;border:none;border-radius:8px;padding:10px 16px;font-size:1.1rem;box-shadow:0 2px 8px #0002;cursor:pointer">üîî</button>
    <div class="header-inner">
      <a class="brand" href="index.html"><img src="logo.svg" class="logo" alt="DBTeam"/> <span>DBTeam</span></a>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="index.html">Inicio</a>
        <a href="chat.html">Chat</a>
        <a href="telegram.html">Telegram</a>
        <a href="monitor.html">Monitor</a>
        <a href="traducciones.html">Traducciones</a>
        <button id="forceTranslateBtn" style="display:none;margin-left:12px">Forzar traducci√≥n autom√°tica</button>
          <script>
          async function checkOwner() {
            // Verifica si el usuario es owner/admin por sesi√≥n
            const token = localStorage.getItem('authToken');
            if (!token) return false;
            const resp = await fetch('/translations/suggestions', { headers: { 'Authorization': 'Bearer ' + token } });
            if (resp.status === 200) {
              document.getElementById('forceTranslateBtn').style.display = '';
              return true;
            }
            return false;
          }
          checkOwner();
          document.getElementById('forceTranslateBtn').onclick = async function() {
            const token = localStorage.getItem('authToken');
            const scope = 'bot';
            const resp = await fetch('/translations/auto', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
              body: JSON.stringify({ scope })
            });
            if (resp.ok) {
              alert('Traducci√≥n autom√°tica iniciada');
            } else {
              alert('No autorizado o error');
            }
          };
          </script>
        <a href="links.html">Enlaces</a>
        <a href="status.html">Estado</a>
        <a href="bot_settings.html">Bots</a>
        <a href="owner.html">Owner</a>
      </nav>
      <div class="header-actions">
        <a href="login.html" class="btn">Login</a>
        <a href="register.html" class="btn ghost">Registro</a>
      </div>
      <button class="nav-toggle" aria-label="Abrir men√∫">‚ò∞</button>
    </div>
  </header>

  <main class="container">
  <div class="wrap">
    <h1>Panel Owner</h1>
    <p style="color:var(--muted);margin-top:6px">Gestiona usuarios, bots y consulta par√°metros clave de la API.</p>
    <div class="panel-row">
      <div class="panel-col">
        <section class="card" style="margin-bottom:18px">
          <h2 style="margin:0 0 10px 0">Panel unificado de chats y ban</h2>
          <button id="reloadUnifiedChatsBtn" class="ghost">Recargar</button>
          <div id="unifiedChatsPanel" style="background:#181f2a;padding:12px 8px;border-radius:10px;min-height:80px;max-height:420px;overflow-y:auto"></div>
        </section>
        <section class="card" style="margin-bottom:18px">
          <h2 style="margin:0 0 10px 0">Chats de Bots cl√°sicos</h2>
          <button id="reloadClassicChatsBtn" class="ghost">Recargar</button>
          <div id="classicChatsPanel" style="background:#181f2a;padding:12px 8px;border-radius:10px;min-height:80px;max-height:320px;overflow-y:auto"></div>
        </section>
        <section class="card" style="margin-bottom:18px">
          <h2 style="margin:0 0 10px 0">Chats de TDLib</h2>
          <button id="reloadTdlibChatsBtn" class="ghost">Recargar</button>
          <div id="tdlibChatsPanel" style="background:#181f2a;padding:12px 8px;border-radius:10px;min-height:80px;max-height:320px;overflow-y:auto"></div>
        </section>
      </div>
      <div class="panel-col">
        <!-- Aqu√≠ puedes a√±adir otros paneles o informaci√≥n relevante -->
      </div>
    </div>
  </div>
  <!-- Panel de gesti√≥n de grupos y chats del bot -->
  <section id="botGroupsPanel" style="display:block;margin-bottom:18px;border:1px solid #444;padding:12px;border-radius:8px;background:#181818;max-width:700px;">
    <h2>Grupos y chats del bot</h2>
    <div id="botGroupsList">Cargando...</div>
  </section>
    <script>
    async function cargarAnunciosPublicados() {
      const panel = document.getElementById('anunciosPublicadosPanel');
      panel.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/api/anuncios_publicados');
        const data = await res.json();
        if (!data.anuncios || !data.anuncios.length) {
          panel.innerHTML = '<span style="color:#888">No hay anuncios publicados.</span>';
          return;
        }
        let html = `<table style='width:100%;margin-top:8px'><thead><tr><th>T√≠tulo</th><th>Canal</th><th>Hora</th><th>Visitas</th><th>Enlace</th></tr></thead><tbody>`;
        data.anuncios.forEach(a => {
          html += `<tr>` +
            `<td>${a.titulo}</td>` +
            `<td>${a.canal || '-'}</td>` +
            `<td>${a.hora || '-'}</td>` +
            `<td>${a.visitas || 0}</td>` +
            `<td><a href='${a.enlace}' target='_blank'>Ver anuncio</a></td>` +
            `</tr>`;
        });
        html += '</tbody></table>';
        panel.innerHTML = html;
      } catch (e) {
        panel.innerHTML = '<span style="color:#f44">Error cargando anuncios.</span>';
      }
    }
    cargarAnunciosPublicados();
    </script>

    <!-- NUEVO BLOQUE DE CREACI√ìN DE USUARIOS Y ADMINISTRADORES -->
    <section class="card" style="margin-bottom:18px;padding:18px;background:#181818;border-radius:10px;border:1px solid #444;">
      <h2 style="margin-bottom:12px">Crear usuarios y administradores</h2>
      <div style="display:flex;flex-wrap:wrap;gap:32px">
        <!-- Usuario normal -->
        <div style="min-width:260px">
          <h3 style="margin-bottom:8px">Usuario normal</h3>
          <input id="userUserInput" type="text" placeholder="Usuario" style="width:120px;margin-bottom:6px" />
          <input id="userPassInput" type="password" placeholder="Contrase√±a" style="width:120px;margin-bottom:6px" />
          <button id="userCreateBtn">Crear</button>
          <span id="userCreateMsg" style="margin-left:10px;color:#6c6"> </span>
        </div>
        <!-- Administrador -->
        <div style="min-width:260px">
          <h3 style="margin-bottom:8px">Administrador</h3>
          <input id="adminUserInput" type="text" placeholder="Usuario" style="width:120px;margin-bottom:6px" />
          <input id="adminPassInput" type="password" placeholder="Contrase√±a" style="width:120px;margin-bottom:6px" />
          <button id="adminCreateBtn">Crear</button>
          <span id="adminCreateMsg" style="margin-left:10px;color:#6c6"> </span>
        </div>
        <!-- Admin de traducciones -->
        <div style="min-width:260px">
          <h3 style="margin-bottom:8px">Admin de traducciones</h3>
          <input id="transAdminUserInput" type="text" placeholder="Usuario" style="width:120px;margin-bottom:6px" />
          <input id="transAdminPassInput" type="password" placeholder="Contrase√±a" style="width:120px;margin-bottom:6px" />
          <button id="transAdminCreateBtn">Crear</button>
          <span id="transAdminCreateMsg" style="margin-left:10px;color:#6c6"> </span>
        </div>
      </div>
    </section>
          <section class="card">
            <div style="display:flex;align-items:center;gap:12px">
              <h2 style="margin:0">Grupos bloqueados (solo owner puede usar comandos)</h2>
              <button id="refreshGroupLocks" class="secondary">Actualizar lista</button>
            </div>
            <div id="groupLocksList" style="margin-top:12px"></div>
          </section
      <div style="display:flex;align-items:center;gap:12px">
        <h2 style="margin:0">Modo Owner-only</h2>
        <label style="display:flex;align-items:center;gap:8px;font-size:1rem">
          <input type="checkbox" id="ownerLockToggle" /> Activar owner-only
        </label>
        <span id="ownerLockStatus" style="color:var(--muted);margin-left:12px">Estado: desconocido</span>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end">
        <div style="flex:1;min-width:220px">
          <label for="apiBase">API base</label>
          <input id="apiBase" list="apiBaseList" value="http://127.0.0.1:8081" placeholder="http://127.0.0.1:8081" />
          <datalist id="apiBaseList"></datalist>
        </div>
        <div style="flex:1;min-width:220px">
          <label for="apiToken">Token/Bearer</label>
          <input id="apiToken" placeholder="session token o api key" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="saveConnection" class="secondary">Guardar</button>
          <button id="refreshAll" class="btn">Recargar datos</button>
        </div>
      </div>
      <div id="connectionStatus" style="margin-top:8px;color:var(--muted);font-size:0.9rem">Sin comprobar</div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Torrents descargados</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="torrentSearch" placeholder="Buscar torrents..." style="min-width:220px" />
          <button id="torrentSearchBtn" class="secondary">Buscar</button>
          <button id="torrentClearBtn" class="ghost">Limpiar</button>
          <button id="myTorrentsBtn" class="secondary">Mis torrents</button>
          <select id="torrentTargetSelect" style="min-width:180px">
            <option value="local">Local (este servidor)</option>
          </select>
          <input id="assignUser" placeholder="Asignar a usuario (opcional)" style="min-width:160px" />
          <input id="torrentFile" type="file" accept=".torrent" style="display:inline-block" />
          <button id="uploadTorrentBtn" class="btn">Subir</button>
          <button id="viewUserPanel" class="secondary">Ver panel usuario</button>
          <button id="refreshTorrents" class="secondary">Actualizar</button>
        </div>
      </div>
      <div id="torrentsList" style="margin-top:12px">
        <div class="mini-body" style="color:var(--muted)">Sin datos</div>
      </div>
    </section>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Monitor de servicios</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startMonitorBtn" class="btn">Iniciar monitor</button>
          <button id="stopMonitorBtn" class="secondary">Detener monitor</button>
          <button id="restartMonitorBtn" class="ghost">Reiniciar</button>
        </div>
      </div>
      <div style="margin-top:12px">
        <div id="monitorStatusText" class="mini-body" style="color:var(--muted)">Estado: desconocido</div>
        <pre id="monitorLog" style="margin-top:8px;padding:8px;border-radius:6px;background:var(--panel);height:160px;overflow:auto;font-size:0.85rem;color:var(--muted)">Cargando logs...</pre>
        <div id="serviceControls" style="margin-top:8px">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <button id="restartAllServicesBtn" class="btn">Reiniciar todos</button>
          </div>
        </div>
      </div>
    </section>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Resumen</h2>
        <button id="refreshOverview" class="secondary">Actualizar</button>
      </div>
      <div class="grid" style="margin-top:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div class="mini-card">
          <div class="mini-title">Estado</div>
          <div id="statusSummary" class="mini-body">Sin datos</div>
        </div>
        <div class="mini-card">
          <div class="mini-title">Bots</div>
          <div id="botStatsSummary" class="mini-body">Sin datos</div>
        </div>
        <div class="mini-card">
          <div class="mini-title">Sesiones</div>
          <div id="sessionSummary" class="mini-body">Sin datos</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Usuarios</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="newUser" placeholder="usuario" style="width:160px" />
          <input id="newPass" placeholder="contrase√±a" style="width:160px" />
          <label style="display:flex;align-items:center;gap:6px;font-size:0.9rem;color:var(--muted)"><input type="checkbox" id="newIsAdmin" /> Admin</label>
          <button id="genPassEmail" class="secondary" title="Genera una contrase√±a aleatoria, la coloca en el campo y abre tu cliente de correo para enviarla">Generar y enviar</button>
          <button id="createUser" class="btn">Crear</button>
        </div>
      </div>
      <div style="overflow-x:auto;margin-top:10px">
        <table class="table">
          <thead>
            <tr><th>Usuario</th><th>Admin</th><th>Creado</th><th>Acciones</th></tr>
          </thead>
          <tbody id="usersTable"><tr><td colspan="4" style="text-align:center;color:var(--muted)">Sin datos</td></tr></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Bots y dispositivos</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="discoverLan" class="secondary">Descubrir en LAN</button>
          <button id="refreshBots" class="secondary">Actualizar bots</button>
        </div>
      </div>
      <div id="botsList" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px">
        <div class="mini-body" style="color:var(--muted)">Sin datos</div>
      </div>
      <div id="discoverResults" class="mini-body" style="margin-top:12px;color:var(--muted)">Descubrimiento LAN no iniciado</div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Modelos (IA)</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="refreshModels" class="secondary">Actualizar</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <input id="modelNameInput" placeholder="model name (e.g. gpt2 or facebook/opt-350m)" style="flex:1;min-width:260px" />
        <button id="installModelBtn" class="btn">Instalar modelo</button>
      </div>
      <div id="installedModels" style="margin-top:12px">Modelos instalados: <span id="installedModelsList" style="color:var(--muted)">Cargando...</span></div>
      <div id="modelInstallStatus" style="margin-top:8px;color:var(--muted)"></div>
      <div id="modelCatalog" style="margin-top:12px"></div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Geo</h2>
        <button id="refreshGeo" class="secondary">Actualizar geo</button>
      </div>
      <div class="geo-grid">
        <div class="geo-block">
          <div class="mini-title" style="margin-bottom:4px">Bots</div>
          <div id="geoBots" class="mini-body">Geo bots: sin datos</div>
          <div id="mapBots" class="geo-map" aria-label="Mapa de bots"></div>
        </div>
        <div class="geo-block">
          <div class="mini-title" style="margin-bottom:4px">Usuarios</div>
          <div id="geoUsers" class="mini-body">Geo usuarios: sin datos</div>
          <div id="mapUsers" class="geo-map" aria-label="Mapa de usuarios"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="owner.js"></script>
  <script src="shared.js"></script>
</body>
</html>
