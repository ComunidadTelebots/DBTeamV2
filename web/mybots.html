<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis Bots - Informaci√≥n y Estad√≠sticas</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/static/shared.css" />
  <style>
    :root {
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --bg: #071028;
      --card: #0b1220;
      --text: #e6eef8;
      --muted: #b0b8c9;
    }
    [data-theme="light"] {
      --bg: #f4f7fb;
      --card: #fff;
      --text: #1a2233;
      --muted: #6b7280;
    }
    body {
      background: linear-gradient(180deg, var(--bg), #021021);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      font-family: Inter, Arial, sans-serif;
    }
    .site-header {
      background: var(--card);
      box-shadow: 0 2px 8px rgba(31,38,135,0.08);
    }
    .main-nav a, .header-actions a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
      margin-right: 12px;
      transition: color 0.2s;
    }
    .main-nav a:hover, .header-actions a:hover {
      color: var(--accent-2);
    }
    [data-theme="light"] .main-nav a, [data-theme="light"] .header-actions a {
      color: #2563eb;
    }
    [data-theme="light"] .main-nav a:hover, [data-theme="light"] .header-actions a:hover {
      color: #7c3aed;
    }
    .theme-toggle-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      margin-left: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .theme-toggle-btn:hover {
      background: var(--accent-2);
    }
    .bot-card { background: var(--card); border-radius: 8px; box-shadow: 0 2px 8px #0001; margin-bottom: 2em; padding: 1.5em; }
    .bot-header { display: flex; align-items: center; justify-content: space-between; }
    .bot-title { font-size: 1.2em; font-weight: bold; color: var(--accent-2); }
    .bot-id { font-size: 0.95em; color: var(--muted); }
    .bot-token { font-size: 0.95em; color: var(--accent); margin-left: 1em; }
    .bot-meta { font-size: 0.95em; color: var(--muted); margin-top: 0.5em; }
    .stat { font-size: 1.1em; margin-top: 0.7em; }
    .bot-avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 1em; }
    .bot-info { margin-bottom: 1em; }
    .bot-actions { margin-top: 1em; }
    button { background: var(--accent); color: #fff; border: none; border-radius: 5px; padding: 0.5em 1.2em; cursor: pointer; }
    button:hover { background: var(--accent-2); }
    .charts { margin-top: 2em; }
  </style>
</head>
<body>
  <header class="site-header">
    <aside id="notificationSidebar" style="position:fixed;right:-340px;top:0;height:100vh;width:320px;background:var(--card,#181f2a);box-shadow:-2px 0 8px #0002;z-index:1000;transition:right 0.3s;overflow-y:auto;padding:18px 16px 16px 16px;display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:700;font-size:1.2rem">Notificaciones</span>
        <button id="closeSidebarBtn" class="btn ghost" style="font-size:1.2rem">√ó</button>
      </div>
      <div style="margin-bottom:12px">
        <label for="tgChannelInput" style="font-size:0.95rem;color:#888">Canal Telegram para notificaciones</label>
        <input id="tgChannelInput" type="text" placeholder="@micanal o -100123456789" style="width:100%;margin-top:4px" />
        <button id="saveTgChannelBtn" class="btn" style="margin-top:6px">Guardar canal</button>
        <span id="tgChannelStatus" style="margin-left:8px;color:#888"></span>
      </div>
      <div id="notificationList"></div>
    </aside>
    <button id="openSidebarBtn" style="position:fixed;right:12px;top:60px;z-index:1001;background:var(--owner-color,#1e90ff);color:#fff;border:none;border-radius:8px;padding:10px 16px;font-size:1.1rem;box-shadow:0 2px 8px #0002;cursor:pointer">üîî</button>
    <div class="header-inner">
      <a class="brand" href="index.html"><img src="logo.svg" class="logo" alt="DBTeam"/> <span>DBTeam</span></a>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="index.html">Inicio</a>
        <a href="chat.html">Chat</a>
        <a href="telegram.html">Telegram</a>
        <a href="monitor.html">Monitor</a>
        <a href="traducciones.html">Traducciones</a>
        <button id="forceTranslateBtn" style="display:none;margin-left:12px">Forzar traducci√≥n autom√°tica</button>
        <a href="links.html">Enlaces</a>
        <a href="status.html">Estado</a>
        <a href="bot_settings.html">Bots</a>
        <a href="owner.html">Owner</a>
      </nav>
      <div class="header-actions">
        <a href="login.html" class="btn">Login</a>
        <a href="register.html" class="btn ghost">Registro</a>
      </div>
      <button class="nav-toggle" aria-label="Abrir men√∫">‚ò∞</button>
    </div>
  </header>
  <script>
    // Tema: claro/oscuro con persistencia
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      var btn = document.getElementById('themeToggleBtn');
      if (btn) btn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    }
    document.addEventListener('DOMContentLoaded', function() {
      const saved = localStorage.getItem('theme') || 'dark';
      setTheme(saved);
      var btn = document.getElementById('themeToggleBtn');
      if (btn) btn.addEventListener('click', toggleTheme);
    });
  </script>
  <main>
    <h1>Mis Bots - Informaci√≥n y Estad√≠sticas</h1>
    <div id="bots"></div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function fetchBots() {
      const res = await fetch('/bot/mybots');
      const data = await res.json();
      renderBots(data.bots || []);
    }
    async function fetchBotStats(token) {
      // Suponiendo que existe endpoint /bot/stats?token=...
      const res = await fetch(`/bot/stats?token=${encodeURIComponent(token)}`);
      return await res.json();
    }
    async function renderBots(bots) {
      const container = document.getElementById('bots');
      container.innerHTML = '';
      if (!bots.length) {
        container.innerHTML = '<p>No tienes bots registrados.</p>';
        return;
      }
      for (const bot of bots) {
        const stats = await fetchBotStats(bot.token);
        const html = `
          <div class="bot-card">
            <div class="bot-header">
              <img src="${bot.avatar || '/logo.svg'}" class="bot-avatar" alt="avatar">
              <span class="bot-title">${bot.name || 'Sin nombre'}</span>
              <span class="bot-id">ID: ${bot.info?.match(/ID: (\d+)/)?.[1] || ''}</span>
              <span class="bot-token">Token: ${bot.token.slice(0, 8)}...*</span>
            </div>
            <div class="bot-info">${bot.info || ''}</div>
            <div class="bot-meta">
              Estado: <strong style="color:${bot.statusColor}">${bot.status}</strong><br>
              <span id="tor-status-${bot.token}"></span>
              <div id="bot-list"></div>
              <canvas id="chatsChart" height="120"></canvas>
              <canvas id="membersChart" height="120"></canvas>
              <canvas id="messagesChart" height="120"></canvas>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                async function loadBots() {
                    const resp = await fetch('/api/bot/mybots');
                    const data = await resp.json();
                    const bots = data.bots || [];
                    let html = '';
                    let names = [], chats = [], members = [], messages = [];
                    for (const bot of bots) {
                        names.push(bot.name);
                        chats.push(bot.total_chats||0);
                        members.push(bot.total_members||0);
                        messages.push(bot.total_messages||0);
                        html += \`<div class='bot-info'>
                            <b>Nombre:</b> \${bot.name}<br>
                            <b>Estado:</b> \${bot.status}<br>
                            <b>Token:</b> \${bot.token.slice(0,8)}...*<br>
                            <b>Info:</b> \${bot.info}<br>
                            <b>Avatar:</b> \${bot.avatar}<br>
                            <b>Propietario:</b> \${bot.owner}<br>
                            <b>Fecha importaci√≥n:</b> \${bot.security?.imported_at}<br>
                            <b>IP importaci√≥n:</b> \${bot.security?.import_ip}<br>
                            <b>Regi√≥n:</b> \${bot.security?.region}<br>
                            <b>Tor:</b> \${bot.tor_enabled ? 'S√≠' : 'No'}<br>
                            <b>Hash esperado:</b> \${bot.expected_hash}<br>
                            <b>Chats:</b> \${bot.total_chats}<br>
                            <b>Miembros:</b> \${bot.total_members}<br>
                            <b>Mensajes:</b> \${bot.total_messages}<br>
                            <b>C√≥digo verificado:</b> \${bot.security?.code_verified ? 'S√≠' : 'No'}<br>
                            <b>Instrucciones prohibidas:</b> \${bot.security?.forbidden_found ? 'S√≠' : 'No'}<br>
                        </div><hr>\`;
                    }
                    document.getElementById('bot-list').innerHTML = html;
                    // Gr√°fico de chats
                    new Chart(document.getElementById('chatsChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: names,
                            datasets: [{label: 'Chats', data: chats, backgroundColor: '#2196f3'}]
                        },
                        options: {responsive: true, plugins: {legend: {display: false}}, title: {display: true, text: 'Chats por bot'}}
                    });
                    // Gr√°fico de miembros
                    new Chart(document.getElementById('membersChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: names,
                            datasets: [{label: 'Miembros', data: members, backgroundColor: '#4caf50'}]
                        },
                        options: {responsive: true, plugins: {legend: {display: false}}, title: {display: true, text: 'Miembros por bot'}}
                    });
                    // Gr√°fico de mensajes
                    new Chart(document.getElementById('messagesChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: names,
                            datasets: [{label: 'Mensajes', data: messages, backgroundColor: '#ff9800'}]
                        },
                        options: {responsive: true, plugins: {legend: {display: false}}, title: {display: true, text: 'Mensajes por bot'}}
                    });
                }
                loadBots();
              </script>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      }
    }
    fetchBots();
  </script>
  <script src="owner.js"></script>
</body>
</html>
